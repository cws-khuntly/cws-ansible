#=====  ANSIBLE   =============================================================
#          NAME:  build-ecelerity/templates/ecelerity.j2
#   DESCRIPTION:  "{{ ansible_managed }}"
#==============================================================================
#########################################################
# ecelerity.conf configuration file 
#########################################################

Esmtp_Listener {
    # Advertise RFC 2034 support for smart SMTP clients
    SMTP_Extensions = ( "ENHANCEDSTATUSCODES" )

    # Globally set a 5 minute timeout on inbound connections
    #
    Idle_Time = 300

    {% if server_type is smtp %}
    Peer "10.0.0.0/8" {
        SMTP_Extensions = (
            "ENHANCEDSTATUSCODES"
            "XDUMPCONTEXT"
        )
        Context = [
            trusted = "yes"
        ]

        Open_Relay = "true"
    }
    {% endif %}

    # Internal relays
    <% for host in hosts %>
    Listen ":{{ host.port }}" {
        TLS_Certificate = "{{ install_dir }}/etc/conf/default/ssl/mail.{{ host.domain }}.crt"
        TLS_Key = "{{ install_dir }}/etc/conf/default/ssl/mail.{{ host.domain }}.key"
        TLS_Client_CA = "{{ install_dir }}/etc/conf/default/ssl/mail.{{ host.domain }}.chain"
        TLS_Ciphers = "{{ include_ciphers }}"
        SMTP_Extensions = (
            "ENHANCEDSTATUSCODES"
            "XDUMPCONTEXT"
            "STARTTLS"
        )
        Context = [
            {% if server_type is smtp %}
                smtp = "true"
                listener_domain = "{{ host.domain }}"
            {% else %}
                mx = "true"
            { % endif %}
        ]

        banner_hostname = "{{ server_type }}.{{ host.domain }}"
        received_hostname = "{{ server_type }}.{{ host.domain }}"
    }

    <% endfor %>
}

# Hosts from which you will accept mail.  Format is a list of
# IPs and CIDR netmasks. By default, do not relay for anyone.
# To accept all hosts on the 10.x.x.x network and localhost,
# you would set this to 
# Relay_Hosts = ( "10.0.0.0/8" "127.0.0.1/32" ::1 )
# You can also set this option in your ESMTP listener ACLs too
#Relay_Hosts = ( "127.0.0.1/32" ::1 )
Relay_Hosts = ( "0.0.0.0/0" ::1 )
TLS = "ifavailable"

# Hosts to which you never want to deliver mail.  This prevents mail loops
# if an RBL technique tries to make Ecelerity deliver to a local address
Prohibited_Hosts = ( "127.0.0.0/8" 0.0.0.0 )

#
# Bounce Handling Directives
#

# Sending domains for which we want to process inbound mails as bounces. 
# This can be left-globbed.  You need to configure this for inbound bounce
# processing to work correctly.
Bounce_Domains = ()

# How to treat bounces.  Normally messages that are flagged as bounces
# are passed through the system after logging.  You may also configure
# this to 'blackhole' or silently drop bounce messages after they have
# been logged by interested loggers.
Bounce_Behavior = pass

# Ports on which the control listener should listen.  By default
# it binds to the UNIX domain socket /tmp/2025.  IPs are also accepted.
# By default, we assume that you are running with our database backend;
# user credentials and permissions are stored there.
Control_Listener {
  AuthDigestMD5Parameters = [
    uri = "ecauth://"
  ]
  Enable_Authentication = "true"

  Enable_Authorization = "false"
  AuthorizationParameters = [
    uri = "ecauth://"
  ]

  Listen "/tmp/2025" {
    Enable_Authentication = "false"
  }
  Listen "127.0.0.1:2025" {
  }
}

include "webui-common.conf"
#########################################################
#
# THINGS YOU MAY CONFIGURE (BUT DONT NEED TO)
#
#########################################################
#########################################################
#
# SECURITY RELATED
#
#########################################################
# This setting allows ecelerity to drop privileges and run as the
# {{ user_name }} role user.
# The product packaging is designed to run this way.
# Changing from {{ user_name }} is not recommended, as you will have to
# take extra measures to ensure that the ownership and permissions
# on many files and directories are set correctly.
# Note that in a cluster configuration, you will want to change
# the Capabilities and Privilege options if you want to enable
# duravip.  This is handled for you when you include the
# ecelerity-cluster.conf file (search for that line in this file)
Security {
    user = {{ user_name }}
    group = {{ group_name }}

    # On Linux, allow binding to privileged ports without requiring
    # a process restart
    Capabilities = "cap_net_bind_service+ep"

    # On Solaris, allow binding to privileged ports without requiring
    # a process restart
    Privileges = "basic net_privaddr net_rawaccess"
}

# Reversible Encryption support
# DO NOT DISABLE THIS if you added this during installation
#
# securecreds {}
#########################################################
#
# MONITORING RELATED
#
#########################################################
# Enable SNMP support.
# If you want to change the IP/port/Community settings, you also need
# to update the ec_stat_watcher.conf file to match.
SNMP {
    State = enabled
    # Bind to 8162 so as to not conflict with native snmp daemons
    Address = 127.0.0.1:8162
    Community = "public"
}

#########################################################
#
# PROTOCOL RELATED
#
#########################################################
# Set the hostname used in the EHLO command.  Options are
# 1) __hostname__  which sets it to the configured hostname of the machine
# 2) __message__  which sets it to the domain of the sender as set in
#    the FROM line (you probably don't want to use this - unless you know
#    know the rDNS on your FROM domains maps back to your IP)
# 3) example.com sets it to the specified hostname
EHLO_Hostname = {{ server_type }}.{{ domain }}

#########################################################
#
# NETWORK RELATED
#
#########################################################
# The max number of total outbound connections.
# Be sure and change the setting of Server_Max_File_Descriptors to match
# this value if above 1000 or so
Server_Max_Outbound_Connections = 20000

# The max number of OS level file descriptors.
# This is very OS dependent and may require changing kernel defaults
# It should be at least Server_Max_Outbound_Connections * 4 or higher
Server_Max_File_Descriptors = 80000

# Additional connections above and beyond the "max" that will be used
# to handle domains that have messages in the active queue that cannot
# be acted on when Server_Max_Outbound_Connections has been reached.
Server_Reserve_Outbound_Connections = 200

# The interval in seconds to scan domains that will require a "reserve"
# connection.
Reserve_Maintenance_Interval = 15

# The max number of outbound connections for a single domain
#Max_Outbound_Connections = 32

# This tells Ecelerity to allocate connections to bindings more
# aggressively.  
# Connection_Allocation_Aggressiveness = high

# Optional address to bind local end of outbound TCP sockets to. 
# Used for vhosting.
#
# Bind_Address = 10.1.2.3

# How often to retry DNS lookups on domains that generate DNS errors
Host_Failure_Retry =  120

#########################################################
#
# TIMEOUTS, EXPIRATIONS AND FAILURES
#
#########################################################
# Allow Ecelerity to send out-of-band bounce messages.  This can be abused
# by spammers.  For bounce processing of mailing lists, you can process
# the bounces as they are written to the delivery log.
# For high volume outbound systems, Generate_Bounces should be false as the
# extra generated bounce messages require delivery and that can reduce the
# delivery rate of sucessful, customer-bound mail.
# Setting this to false will violate Internet RFCs if the machine is used
# as a general mail gateway.
Generate_Bounces = true

# If bounces are being generated, the From: address will be the value of
# MailerDaemon.  Default:
MailerDaemon = no-reply@{{ domain }}

# Ecelerity _can_ refuse messages that have a null envelope sender like
# MAIL FROM:<>.  Note, setting this to false violates Internet RFCs.
Allow_Null_Envelope_Sender = true

# The base retry period for a mail.  Ecelerity uses an exponential 
# backoff algorithm for determining when to retry failed deliveries.
# Default: 20 minutes
Retry_Interval = 1200

# When a message should expire due to non-deliverability.  Default 1 week.
Message_Expiration = 604800

# Delayed_Binding_Domain_Fuzz must be a power-of-two value from 2 - n.
# It represents the number of seconds to spread scheduled messages over
# in the case that ecelerity determines that a bulk requeue is necessary.
# The default value is 0 seconds. It is possible to set this to values
# that are not powers of two, but this may result in sub-optimal
# performance and ecelerity scheduler congestion.
#
# Delayed_Binding_Domain_Fuzz = 4096
#

# Timeouts for various stages of SMTP
# These are very conservative and based on RFC 1123
Connect_Timeout = 60
EHLO_Timeout = 300
Mailfrom_Timeout = 300
Rcptto_Timeout = 300
Body_Timeout = 600
Rset_Timeout = 300
Idle_Timeout = 5
RSET_Timeout = 120 # Up the default RSET timeout

# The port to send outbound smtp on
Remote_SMTP_Port = 25

# The maximum number of messages in a given domain's active queue before 
# aggressive memory management is performed on that domain.
#
# This is a per binding setting.  If you have lots of memory then setting 
# this to a higher value (like perhaps 10000) could help performance a lot.
Max_Resident_Active_Queue = 250

# The maximum number of messages to retain in memory, server wide.
# A rough guide to setting this option is to divide the maximum amount
# of RAM that you want to reserve for messages by your large_message_threshold.
# This default value assumes that you have 8GB of memory available
# and that you are using the default large_message_threshold of 128k.
# Actual memory usage may be less than this if your average message is 
# smaller than large_message_threshold.
Max_Resident_Messages = 65536

# The maximum percentage of physical memory that Ecelerity should
# aim to use during normal operation.  If this threshold is exceeded,
# the server will free up some resources to try to bring memory usage
# within acceptable bounds
Memory_Goal = 90

# The maximum percentage of physical memory that Ecelerity should
# be using.  This is a "harder" limit than the Memory_Goal;
# when this threshold is exceeded, new mail will be transiently failed,
# and the server will aggressively free up resources to bring memory usage
# within acceptable bounds more quickly.
Memory_HWM = 95

# Additionally, timeouts and ports can be specified on a per-domain basis
#
#Domain earthlink.net {
#   Max_Outbound_Connections = 12
#   Message_Expiration = 900
#   Max_Resident_Active_Queue = 1000
#}

#########################################################
#
# ON-DISK QUEUE
#
#########################################################
# The base directory where the mail queue spool is stored.
# If you change this, make certain to change the location of the IO
# module headers cache DBM, which is usually (though not necessarily) 
# in the same directory.
SpoolBase = "/var/spool/ecelerity"

# Whether to use mmap() for message bodies.  Recommended to
# enable on Linux 2.4.x.  Be aware that if you enable this, that
# you may need to increase the number of OS allowed mmap() segments per
# process, see the Installation section of the manual or your 
# operating system manual for details.
Use_MMAP = false

# How fast to spool in queued messages on start.
Disk_Queue_Drain_Rate = 100

# The mode with which spool files are created.
Spool_Mode = 0644

# Set the number of worker threads for asynchronous message body swapout. 
ThreadPool SwapOut {
    Concurrency = 20
}
# Set the number of worker threads for asynchronous message body swapin. 
ThreadPool SwapIn {
    Concurrency = 20
}

#########################################################
#
# Internals
#
#########################################################
# RFC822 recommends that MTAs add trace headers.  These include:
# Return-path: <...>
# Received: from .....
#
# There are technical reasons why you may wish to disable this feature in
# a large outbound mail infrastructure with fewer generation machines than
# Ecelerity instances.  If "true", the message will have appeared to the
# end user to have originated from the generating machine. If "false", the
# message will appear to have originated from the Ecelerity machine.
#
RFC2822_Trace_Headers = true
RFC2822_Lone_LF_in_Headers = pedantic
RFC2822_Lone_LF_in_Body = ignore
RFC2822_Date_Header = ifneeded  

# RFC2822_Max_Line_Length_Policy defines how to handle messages with
# non-RFC-compliant line lengths. The default policy of none is to
# do nothing about such messages and process them as usual. The fix
# policy will attempt to fix the body of the message to limit line
# lengths. The reject policy will reject such messages.
# 
# RFC2822_Max_Line_Length_Policy = none
# RFC2822_Max_Line_Length_Policy = fix
# RFC2822_Max_Line_Length_Policy = reject
#

# RFC2822_Max_Line_Length defines the maximum length of a line
# if RFC2822_Max_Line_Length_Policy is set to fix or reject
# messages. The default value is the RFC-defined limit of 998
# characters, excluding the carriage return and newline characters.
# It is recommended to modify RFC2822_Max_Line_Length to some higher
# value when using a non-ignore line length policy. Some other
# servers allow for larger line length limits (for example, a line
# length limit of 8000 characters is not uncommon).
#
# RFC2822_Max_Line_Length = 2048
#

# Throttle the rate of inbound message reception in messages/second.
#
# Inbound_Throttle_Messages = "400/1"
 
# If set to true, then for domains in our Bounce_Domains and Relay_Domains
# ecelerity will only use the set of lowest numerical priority MXs and
# ignore others; this was the behavior before 2.2.2.30.
Only_Use_Best_MX_For_Relay_Domains = false

#########################################################
#
# EXTENSIONS    
#
#########################################################

# The configured logging module.  Multiple loggers can be used.  
# By default the internal Ecelerity format is used.

ec_logger "ec_logger"
{
    mainlog = "/var/log/ecelerity/mainlog.ec"
    paniclog = "/var/log/ecelerity/paniclog.ec"
    rejectlog = "/var/log/ecelerity/rejectlog.ec"
    acctlog = "/var/log/ecelerity/acctlog.ec"
}

bounce_logger "bounce_logger"
{
    bouncelog = "/var/log/ecelerity/bouncelog.ec"
}

# Statistics producer for the web console graphs (both single instance and
# cluster.
# Required for the webconsole reporting to function
statp "statp" {}

# Journals information on deliveries, rejections for
# consumption by ec_rt_stats2.
# Required for the webconsole reporting to function
ec_logger "ec_logger_rt" {
    mainlog = "jlog:///var/log/ecelerity/mainlog.rt=>ec_rt_stats"
    rejectlog = "jlog:///var/log/ecelerity/rejectlog.rt=>ec_rt_stats"
    log_errors = "false"
}

# Journals information on bounces for consumption by ec_rt_stats2
# Required for the webconsole reporting to function
bounce_logger "bounce_logger_rt" {
    bouncelog = "jlog:///var/log/ecelerity/bouncelog.rt=>ec_rt_stats"
}

# Journals information on SMPP traffic
# Required for collecting & reporting SMPP monthly statistics
# smpp_logger "smpp_rt" {
#   logfile = "jlog:///var/log/ecelerity/smpp.rt=>ec_rt_stats"
# }
#
# And for MM7:
# mms_logger "mm7_rt" {
#   logfile = "jlog:///var/log/ecelerity/mm7.rt=>ec_rt_stats"
# }

# For clustering, uncomment the following line:
include "ecelerity-cluster.conf"

# If using MessageCentral, uncomment the following line:
# readonly_include "/opt/msys/pe2/etc/ecelerity_logger.conf"

# If using Mobile Momentum, uncomment the following line:
# include "mobile.conf"

# In using Message Scope, uncomment the following line:
# include "messagescope.conf"

# Message validation handlers.
mail_loop "mail_loop"
{
    Use_IP = false
}

#Binding example {
# Bind_Address = 127.0.0.1
#}

#
# Macro rules for modules
#
spf_macros {}

#
# Perform DK Validation
#
#dk_validate "dk_validate"  {
#}

#
# Perform DKIM Validation
#
#dkim_validate "dkim_validate"  {
#}

#
# Ratware/Early-Talker Checks
#
#conntrol "earlysender"  {
#        pause_time = 2
#}

#
# SPF Checks
#
#spf_v1 "spf" {
#  default_rule = "?all"
#  add_headers = true
#  add_authentication_results = true
#  context_variable = "spf_status"
#  permerror_code = 250
#  pass_code = 250
#  unknown_code = 250
#  fail_code = 250
#  fail_fallback_string = "SPF validation failure"
#  softfail_code = 250
#  softfail_fallback_string = "SPF validation soft failure"
#  nxdomain_code = 550
#  nxdomain_override_string = "Could not resolve sender's domain"
#}
#
#senderid "senderid" {
#  default_rule = "?all"
#  default_pra_rule = "?all"
#  add_headers = true
#  add_authentication_results = true
#  context_variable = "senderid_status"
#  context_pra_variable = "senderid_pra_status"
#  permerror_code = 250
#  pass_code = 250
#  unknown_code = 250
#  fail_code = 250
#  fail_fallback_string = "SPF validation failure"
#  softfail_code = 250
#  softfail_fallback_string = "SPF validation soft failure"
#  nxdomain_code = 550
#  nxdomain_override_string = "Could not resolve sender's domain"
#}

#
# URL Extraction and Lookup
#
#url_ripper "surbl" {
#        base="bl.omniti.net"
#        max_lookups = 100
#        forward = true
#        bits = [
#                0.0.1.0 = "xbl_hits"
#                0.0.0.1 = "sbl_hits"
#                0.0.0.2 = "sc_surbl_hits"
#                0.0.0.4 = "ws_surbl_hits"
#                0.0.0.8 = "ph_surbl_hits"
#                0.0.0.16 = "ob_surbl_hits"
#                0.0.0.32 = "ab_surbl_hits"
#                0.0.0.64 = "jp_surbl_hits"
#        ]
#        address_headers = (
#          "Errors-To"
#          "From"
#          "Reply-To"
#          "Return-Path"
#          "Sender"
#        )
#}

#
# Broader character set support for sieve
icu {}

# Alerting stanza is required for creation of enhanced policy and alerting
# scripts via the UI.
alerting {}

# Scriptlets provide enhanced policy capabilities and control channel
# commands
scriptlet "scriptlet" {
    # this loads default scripts to support enhanced control channel features
    script "boot" {
        source = "msys.boot"
    }
    <% for script in authscripts %>
    script "{{ script.name }}" {
        source = "{{ script.path }}"
    }

    <% endfor %>
}

## Data Sources ##
<% for datasource in datasources %>
Datasource "{{ datasource.name }}" {
    uri = ( "{{ datasource.uri }}" )
    cache_size = "{{ datasource.cache-size }}"
    cache_life = 900 {{ datasource.cache-life }}"
}

<% endfor %>

# Audit series monitors
inbound_audit {
    monitors = ( "300,6" "1800,4" )
}
outbound_audit "outbound_audit1" {
  monitors = ( "300,6" "1800,4" )
  monitor_domains = on
  threshold = 100
}

cloudmark {
    enabled = false
    MinimumScore = "96"
}

sieve "sieve1" {
    script connect_phase1 {
        source = "{{ install_dir }}/etc/conf/global/siv/connect.siv"
    }

    script mailfrom_phase1 {
        source = "{{ install_dir }}/etc/conf/global/siv/mailfrom.siv"
    }

    script rcptto_phase1 {
        source = "{{ install_dir }}/etc/conf/global/siv/rcptto.siv"
    }

    script data_phase1 {
        source = "{{ install_dir }}/etc/conf/global/siv/data.siv"
    }

    script each_rcpt_phase1 {
        source = "{{ install_dir }}/etc/conf/global/siv/policy_spool.siv"
    }

    script set_binding_phase1 {
        source ="{{ install_dir }}/etc/conf/global/siv/binding_phase.siv"
    }
}

include "{{ install_dir }}/etc/conf/default/default_policy.conf"

Binding "premig.{{ domain }}" {
    Max_Outbound_Connections = 100
    Gateway = 74.125.22.27 
}

### Maildrop Binding ###
{% for maildrop in maildrops %}
  Binding {{ maildrop }} {
    Gateway = {{ maildrop }}
    Delivery_Method = "LMTP"
    LMTP_Port = 7025
  }

{% endfor %}

# Pull in auxillary information prepared by the installer; this must be the
# last thing in the top level ecelerity.conf file, as it is intended to overlay
# the webui-common.conf file (for example)
readonly_include "/opt/msys/etc/installer/ecelerity.d/"

# vim:ts=2:sw=2:et:ft=conf:
