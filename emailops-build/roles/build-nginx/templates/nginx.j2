#=====  ANSIBLE   =============================================================
#          NAME:  templates/nginx.j2
#   DESCRIPTION:  "{{ ansible_managed }}"
#==============================================================================

user                                "{{ nginx_user }}";
worker_processes                    8;
error_log                           /var/log/error.log;
pid                                 /var/run/nginx.pid;

events {
    worker_connections              10240;
}

mail {
    auth_http                       localhost:81/auth.php;
    proxy_issue_pop3_xoip           off;
    proxy_issue_imap_id             off;
    pop3_capabilities               "CAPA" "TOP" "UIDL" "RESP-CODES" "PIPELINING" "STLS" "USER" "SASL PLAIN LOGIN";
    imap_capabilities               "IMAP4rev1" "LITERAL+" "LOGIN-REFERRALS" "ID ENABLE" "IDLE SORT" "SORT=DISPLAY" "THREAD=REFERENCES" "THREAD=REFS" "MULTIAPPEND" "UNSELECT" "CHILDREN" "ESORT" "SEARCHRES" "WINTHIN" "CONTEXT=SEARCH" "QUOTA" "AUTH=PLAIN" "AUTH=LOGIN";

    server {
        listen                      110;
        protocol                    pop3;
        proxy                       on;
        starttls                    on;

        ssl                         on;
        ssl_certificate             "/etc/nginx/ssl/mail.{{ domain }}.crt";
        ssl_certificate_key         "/etc/nginx/ssl/mail.{{ domain }}.key";
        ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
        ssl_session_timeout         5m;
        ssl_ciphers                 "{{ include_ciphers }};
        ssl_prefer_server_ciphers   on;
        ssl_dhparam                 /etc/nginx/ssl/dhparams-nginx.pem;
    }
    server {
        listen                      143;
        protocol                    imap;
        proxy                       on;

        ssl                         on;
        ssl_certificate             "/etc/nginx/ssl/mail.{{ domain }}.crt";
        ssl_certificate_key         "/etc/nginx/ssl/mail.{{ domain }}.key";
        ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
        ssl_session_timeout         5m;
        ssl_ciphers                 "{{ include_ciphers }};
        ssl_prefer_server_ciphers   on;
        ssl_dhparam                 /etc/nginx/ssl/dhparams-nginx.pem;
    }
    server {
        listen                      995;
        protocol                    pop3;
        proxy                       on;

        ssl                         on;
        ssl_certificate             "/etc/nginx/ssl/mail.{{ domain }}.crt";
        ssl_certificate_key         "/etc/nginx/ssl/mail.{{ domain }}.key";
        ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
        ssl_session_timeout         5m;
        ssl_ciphers                 "{{ include_ciphers }};
        ssl_prefer_server_ciphers   on;
        ssl_dhparam                 /etc/nginx/ssl/dhparams-nginx.pem;
    }
    server {
        listen                      993;
        protocol                    imap;
        proxy                       on;

        ssl                         on;
        ssl_certificate             "/etc/nginx/ssl/mail.{{ domain }}.crt";
        ssl_certificate_key         "/etc/nginx/ssl/mail.{{ domain }}.key";
        ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
        ssl_session_timeout         5m;
        ssl_ciphers                 "{{ include_ciphers }};
        ssl_prefer_server_ciphers   on;
        ssl_dhparam                 /etc/nginx/ssl/dhparams-nginx.pem;
    }
}
